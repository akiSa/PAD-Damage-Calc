<!DOCTYPE html>
<html>
  <head>
    <title>lolwut</title>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet"
          href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  </head>
  <body>
    <div class = "container-fluid" ng-app="" ng-controller="mycontroller">
      <div class="container">
        <div class="text-center">
          <form ng-submit="submit()">
            <input type="text" ng-model="teamID" />
            <br>
            <div class="row">

              <div class="col-md-4">
                <div class="col-md-6">
                  <img ng-src="{{image[0]}}" />
                </div>
                <div class="col-md-6">
                  HP: {{stats.hp[0]}}
                  <br>
                  ATK: {{stats.atk[0]}}
                  <br>
                  RCV: {{stats.rcv[0]}}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="col-md-6">
                  <img ng-src="{{image[1]}}" />
                </div>
                <div class="col-md-6">
                  HP: {{stats.hp[1]}}
                  <br>
                  ATK: {{stats.atk[1]}}
                  <br>
                  RCV: {{stats.rcv[1]}}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="col-md-6">
                  <img ng-src="{{image[2]}}" />
                </div>
                <div class="col-md-6">
                  HP: {{stats.hp[2]}}
                  <br>
                  ATK: {{stats.atk[2]}}
                  <br>
                  RCV: {{stats.rcv[2]}}
                </div>
              </div>
              
            </div>
            <br>

            <div class="row">

              <div class="col-md-4">
                <div class="col-md-6">
                  <img ng-src="{{image[3]}}" />
                </div>
                <div class="col-md-6">
                  HP: {{stats.hp[3]}}
                  <br>
                  ATK: {{stats.atk[3]}}
                  <br>
                  RCV: {{stats.rcv[3]}}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="col-md-6">
                  <img ng-src="{{image[4]}}" />
                </div>
                <div class="col-md-6">
                  HP: {{stats.hp[4]}}
                  <br>
                  ATK: {{stats.atk[4]}}
                  <br>
                  RCV: {{stats.rcv[4]}}
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="col-md-6">
                  <img ng-src="{{image[5]}}" />
                </div>
                <div class="col-md-6">
                  HP: {{stats.hp[5]}}
                  <br>
                  ATK: {{stats.atk[5]}}
                  <br>
                  RCV: {{stats.rcv[5]}}
                </div>
              </div>
              
            </div>
            <br>
            Enhanced Orbs:
            <span style="color:red" > {{meta.enhance[0]}} </span>
            <span style="color:blue" > {{meta.enhance[1]}} </span>
            <span style="color:green" > {{meta.enhance[2]}} </span>
            <span style="color:yellow" > {{meta.enhance[3]}} </span>
            <span style="color:black" > {{meta.enhance[4]}} </span>
            <br>

            Rows:
            <span style="color:red" > {{meta.rows[0]}} </span>
            <span style="color:blue" > {{meta.rows[1]}} </span>
            <span style="color:green" > {{meta.rows[2]}} </span>
            <span style="color:yellow" > {{meta.rows[3]}} </span>
            <span style="color:black" > {{meta.rows[4]}} </span>
            <br>
            <br>
          </form>
        </div>
      </div>
      
      <form ng-submit="combo()">
        <div class="container">
          <div class="row">
            <div class="col-sm-4">
              <label for="fireorbs"> Fire: </label>
              <input class="form-control" ng-model="orbs.fire" ng-list required id="fireorbs" />
            </div>
            <div class="col-sm-4">
              <label for="waterorbs"> Water: </label>
              <input class="form-control" ng-model="orbs.water" ng-list required id="waterorbs" />
            </div>
            <div class="col-sm-4">
              <label for="woodorbs"> Wood: </label>
              <input class="form-control" ng-model="orbs.wood" ng-list required id="woodorbs" />
            </div>            
          </div>
          <div class="row">
            <div class="col-sm-4">
              <label for="lightorbs"> Light: </label>
              <input class="form-control" ng-model="orbs.light" ng-list required id="lightorbs" />
            </div>
            <div class="col-sm-4">
              <label for="darkorbs"> Dark: </label>
              <input class="form-control" ng-model="orbs.dark" ng-list required id="darkorbs" />
            </div>
            <div class="col-sm-4">
              <label for="heartorbs"> Heart: </label>
              <input class="form-control" ng-model="orbs.heart" ng-list required id="heartorbs" />
            </div>            
          </div>
          
          <br>
          
          <div class="row">
            <div class="col-sm-6">
              <label for="enhancednum"> Enhanced Orbs: </label>
              <input class="form-control" ng-model="orbs.enhanced_orbs" ng-list required id="enhancednum"/>
            </div>
            <div class="col-sm-6">
              <label for="rownum"> Rows: </label>
              <input class="form-control" ng-model="orbs.rows" ng-list required id="rownum"/>
            </div>
          </div>

          <br>
          
          <!-- This is fucking dumb. -->
          <input type="submit" style="position: absolute; left: -9999px; width: 1px; height: 1px;"/>

          <div class="row">
            <div class="col-sm-4">
              <label for="active"> Active (elem:0, type:1): </label>
              <input class="form-control" type="number" ng-model="orbs.active_ability[0]" id="active"/>
              <!-- NOTE, CHANGE THIS TO A DROPDOWN, BOTH OF THEM (full list of elements/types, just go from there... easier) -->
              <input class="form-control" type="text" ng-model="orbs.active_ability[1]" />
            </div>
          </div>
        Multiplier:
          <input type="number" ng-model="orbs.active_ability[2]" step="0.01" />
          <br>
        Leader Skill: <input ng-model="orbs.leader_skill.condition" ng-list required />
        HP: <input type="number" ng-model="orbs.leader_skill.hp" step="0.01"/>
        ATK: <input type="number" ng-model="orbs.leader_skill.atk" step="0.01"/>
        RCV: <input type="number" ng-model="orbs.leader_skill.rcv" step="0.01"/>
          <br>
        Friend Leader Skill: <input type="text" ng-model="orbs.friend_leader_skill.condition" ng-list required/>
        HP: <input type="number" ng-model="orbs.friend_leader_skill.hp" step="0.01"/>
        ATK: <input type="number" ng-model="orbs.friend_leader_skill.atk" step="0.01"/>
        RCV: <input type="number" ng-model="orbs.friend_leader_skill.rcv" step="0.01"/>
          <br>

        </div>

        <div class="container">
        Damage: {{damage}}
        </div>
        
      </form>
    </div>
  </body>
  
    <script>
    function mycontroller($scope) {
      var sock

      window.onbeforeunload = function closingCode() {
        //Close websocket
        console.log("byebye")
        sock.close()
        return null;
      }

      $scope.typelem = {
        elem: {
          fire: 0,
          water: 1,
          wood: 2,
          light: 3,
          dark: 4,
          heart: 5
        },
        type = {
          evo_material: 0,
          balanced: 1,
          physical: 2,
          healer: 3,
          dragon: 4,
          god: 5,
          attacker: 6,
          devil:7,
          awoken_skill_material: 12,
          protected: 13,
          enhance: 14
        }
      };
      $scope.teamID = "67401";
      $scope.default = [ 0,0 ]
      $scope.conditions = [
        {name: 'element'},
        {name: 'type'}
      ];
      $scope.elements = [
        {name: 'fire', id:  0},
        {name: 'water', id: 1},
        {name: 'wood', id:  2},
        {name: 'light', id: 3},
        {name: 'dark', id:  4},
        {name: 'heart', id: 5},
      ]
      $scope.types = [
        {name: 'Evo', id: 0},
        {name: 'Balanced', id: 1},
        {name: 'Physical', id: 2},
        {name: 'Healer', id: 3},
        {name: 'Dragon', id: 4},
        {name: 'God', id: 5},
        {name: 'Attacker', id: 6},
        {name: 'Devil', id: 7},
        {name: 'Awoken Skill Material', id: 12},
        {name: 'Protected', id: 13},
        {name: 'Enhance', id: 14},
      ]
      $scope.orbs = {
        fire: [0],
        water: [0],
        wood: [0],
        light: [0],
        dark: [0],
        heart: [0],
        enhanced_orbs: [0,0,0,0,0],
        rows: [0,0,0,0,0],
        active_ability: [ "elem", 1, 1 ],
        leader_skill: {
          condition: ["all", 1 ],
          hp: 1,
          atk: 1,
          rcv: 1
        },
        friend_leader_skill: {
          condition: ["all", 1 ],
          hp: 1,
          atk: 1,
          rcv: 1
        }
      };
      $scope.image = [ "", "", "", "", "", "" ];
      $scope.stats = {
        hp: [],
        atk: [],
        rcv: []
      };
      $scope.meta = {
        enhance: [0,0,0,0,0],
        rows: [0,0,0,0,0]
      };
      $scope.damage = ""
      
      $scope.combo = function() {
        for (var $i in $scope.orbs) {
          if ($i != "active_ability" && $i != "leader_skill" && $i != "friend_leader_skill") {
            $scope.orbs[$i] = $scope.orbs[$i].map(function(x) {
                return parseInt(x, 10);
              })
          }
        };

        var copy = $scope.orbs;

        //Need to do this once per element... far too tired to make this /look/ better, so I'm just going to copypasta it
        for(var i = copy.fire.length - 1; i >= 0; i--) {
          if(copy.fire[i] === 0) {
            copy.fire.splice(i, 1);
          }
        }
        for(var i = copy.water.length - 1; i >= 0; i--) {
          if(copy.water[i] === 0) {
            copy.water.splice(i, 1);
          }
        }
        for(var i = copy.wood.length - 1; i >= 0; i--) {
          if(copy.wood[i] === 0) {
            copy.wood.splice(i, 1);
          }
        }
        for(var i = copy.light.length - 1; i >= 0; i--) {
          if(copy.light[i] === 0) {
            copy.light.splice(i, 1);
          }
        }
        for(var i = copy.dark.length - 1; i >= 0; i--) {
          if(copy.dark[i] === 0) {
            copy.dark.splice(i, 1);
          }
        }
        for(var i = copy.heart.length - 1; i >= 0; i--) {
          if(copy.heart[i] === 0) {
            copy.heart.splice(i, 1);
          }
        }

        console.log(JSON.stringify(copy))
        sock.send(JSON.stringify(copy))

        //Check for empty lists
        for (var attr in copy) {
          if (copy[attr].length < 1) copy[attr] = [0];
        }
      };
      
      $scope.submit = function() {
        //54.88.52.106 note, change this val to ip of server
        sock = new WebSocket("ws://54.88.52.106:8080/team/" + $scope.teamID + "/");
        //console.log ($scope.teamID)
        sock.onopen = function () { }
        sock.onmessage = function (message) {
          var m = JSON.parse(message.data);

          if (m.initial) {
            //Initial message
            m.team.forEach(function(entry) {
                console.log(entry);
              });
            
            $scope.$apply(function() {
                for (var i = 0; i < $scope.image.length; i++) {
                  $scope.image[i] = "http://padherder.com/"+m.team[i].image60_href
                  $scope.stats.hp[i] = m.team[i].stats.hp
                  $scope.stats.atk[i] = m.team[i].stats.atk
                  $scope.stats.rcv[i] = m.team[i].stats.rcv
                  $scope.meta.enhance = m.orb_enhances
                  $scope.meta.rows = m.row_enhances
                }
                if (m.team[0].leader_skill.condition != undefined) {
                  $scope.orbs.leader_skill.condition = m.team[0].leader_skill.condition
                } else{
                  $scope.orbs.leader_skill.condition[0] = "all"
                }
                $scope.orbs.leader_skill.hp = m.team[0].leader_skill.hp
                $scope.orbs.leader_skill.atk = m.team[0].leader_skill.atk
                $scope.orbs.leader_skill.rcv = m.team[0].leader_skill.rcv

                if (m.team[5].leader_skill.condition != null) {
                  $scope.orbs.friend_leader_skill.condition = m.team[5].leader_skill.condition
                } else {
                  $scope.orbs.friend_leader_skill.condition[0] = "all"
                }
                $scope.orbs.friend_leader_skill.hp = m.team[5].leader_skill.hp
                $scope.orbs.friend_leader_skill.atk = m.team[5].leader_skill.atk
                $scope.orbs.friend_leader_skill.rcv = m.team[5].leader_skill.rcv
                // if $scope.orbs.friend_leader_skill.condition[0] === "" {
                // 
                // }
              });
          } else {
            $scope.$apply(function() {
                console.log(JSON.stringify(m))
                $scope.damage = JSON.stringify(m)
              });
          }
        }
      };
    }
    </script>
  </body>
</html>
