<!DOCTYPE html>
<html>
  <head>
    <title>lolwut</title>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular.min.js"></script>
  </head>
  <body>
    <div ng-app="" ng-controller="mycontroller">
      <form ng-submit="submit()">
        <input type="text" ng-model="teamID" />
        <br>
        <img ng-src="{{image[0]}}" />
        <img ng-src="{{image[1]}}" />
        <img ng-src="{{image[2]}}" />
        <img ng-src="{{image[3]}}" />
        <img ng-src="{{image[4]}}" />
        <img ng-src="{{image[5]}}" />
        <br>
        HP: {{stats.hp[0]}} {{stats.hp[1]}} {{stats.hp[2]}} {{stats.hp[3]}} {{stats.hp[4]}} {{stats.hp[5]}}
        <br>
        ATK: {{stats.atk[0]}} {{stats.atk[1]}} {{stats.atk[2]}} {{stats.atk[3]}} {{stats.atk[4]}} {{stats.atk[5]}}
        <br>
        RCV: {{stats.rcv[0]}} {{stats.rcv[1]}} {{stats.rcv[2]}} {{stats.rcv[3]}} {{stats.rcv[4]}} {{stats.rcv[5]}}
        <br>
        Enhanced Orbs: {{meta.enhance}}
        <br>
        Rows: {{meta.rows}}
        <br>
      </form>
      
      <form ng-submit="combo()">
        
        Fire: <input ng-model="orbs.fire" ng-list required />
        Water: <input ng-model="orbs.water" ng-list required/>
        Wood: <input ng-model="orbs.wood" ng-list required/>
        Light: <input ng-model="orbs.light" ng-list required/>
        Dark: <input ng-model="orbs.dark" ng-list required/>
        Heart: <input ng-model="orbs.heart" ng-list required/>
        <br>
        #Enhanced orbs: <input ng-model="orbs.enhanced_orbs" ng-list required/>
        #Rows: <input ng-model="orbs.rows" ng-list required/>
        <br>
        <!-- This is fucking dumb. -->
        <input type="submit" style="position: absolute; left: -9999px; width: 1px; height: 1px;"/>
        Active:
        <input type="text" ng-model="orbs.active_ability[0]" />
        <input type="number" ng-model="orbs.active_ability[1]" step="0.01"/>
        Multiplier:
        <input type="number" ng-model="orbs.active_ability[2]" step="0.01" />
        <br>
        Leader Skill: <input ng-model="orbs.leader_skill.condition" ng-list required />
        HP: <input type="number" ng-model="orbs.leader_skill.hp" step="0.01"/>
        ATK: <input type="number" ng-model="orbs.leader_skill.atk" step="0.01"/>
        RCV: <input type="number" ng-model="orbs.leader_skill.rcv" step="0.01"/>
        <br>
        Friend Leader Skill: <input type="text" ng-model="orbs.friend_leader_skill.condition" ng-list required/>
        HP: <input type="number" ng-model="orbs.friend_leader_skill.hp" step="0.01"/>
        ATK: <input type="number" ng-model="orbs.friend_leader_skill.atk" step="0.01"/>
        RCV: <input type="number" ng-model="orbs.friend_leader_skill.rcv" step="0.01"/>
        <br>
        Damage: {{damage}}
        
      </form>
    </div>
  </body>
    <script>
    function mycontroller($scope) {
      var sock

      window.onbeforeunload = function closingCode() {
        //Close websocket
        console.log("byebye")
        sock.close()
        return null;
      }

      $scope.teamID = "77475";
      $scope.default = [ 0,0 ]
      $scope.conditions = [
        {name: 'element'},
        {name: 'type'}
      ];
      $scope.elements = [
        {name: 'fire', id:  0},
        {name: 'water', id: 1},
        {name: 'wood', id:  2},
        {name: 'light', id: 3},
        {name: 'dark', id:  4},
        {name: 'heart', id: 5},
      ]
      $scope.types = [
        {name: 'Evo', id: 0},
        {name: 'Balanced', id: 1},
        {name: 'Physical', id: 2},
        {name: 'Healer', id: 3},
        {name: 'Dragon', id: 4},
        {name: 'God', id: 5},
        {name: 'Attacker', id: 6},
        {name: 'Devil', id: 7},
        {name: 'Awoken Skill Material', id: 12},
        {name: 'Protected', id: 13},
        {name: 'Enhance', id: 14},
      ]
      $scope.orbs = {
        fire: [0],
        water: [0],
        wood: [0],
        light: [0],
        dark: [0],
        heart: [0],
        enhanced_orbs: [0,0,0,0,0],
        rows: [0,0,0,0,0],
        active_ability: [ "elem", 1, 1 ],
        leader_skill: {
          condition: ["all", 1 ],
          hp: 1,
          atk: 1,
          rcv: 1
        },
        friend_leader_skill: {
          condition: ["all", 1 ],
          hp: 1,
          atk: 1,
          rcv: 1
        }
      };
      $scope.image = [ "", "", "", "", "", "" ];
      $scope.stats = {
        hp: [],
        atk: [],
        rcv: []
      };
      $scope.meta = {
        enhance: [],
        rows: []
      };
      $scope.damage = ""
      
      $scope.combo = function() {
        for (var $i in $scope.orbs) {
          if ($i != "active_ability" && $i != "leader_skill" && $i != "friend_leader_skill") {
            $scope.orbs[$i] = $scope.orbs[$i].map(function(x) {
                return parseInt(x, 10);
              })
          }
        };

        var copy = $scope.orbs;

        //Need to do this once per element... far too tired to make this /look/ better, so I'm just going to copypasta it
        for(var i = copy.fire.length - 1; i >= 0; i--) {
          if(copy.fire[i] === 0) {
            copy.fire.splice(i, 1);
          }
        }
        for(var i = copy.water.length - 1; i >= 0; i--) {
          if(copy.water[i] === 0) {
            copy.water.splice(i, 1);
          }
        }
        for(var i = copy.wood.length - 1; i >= 0; i--) {
          if(copy.wood[i] === 0) {
            copy.wood.splice(i, 1);
          }
        }
        for(var i = copy.light.length - 1; i >= 0; i--) {
          if(copy.light[i] === 0) {
            copy.light.splice(i, 1);
          }
        }
        for(var i = copy.dark.length - 1; i >= 0; i--) {
          if(copy.dark[i] === 0) {
            copy.dark.splice(i, 1);
          }
        }
        for(var i = copy.heart.length - 1; i >= 0; i--) {
          if(copy.heart[i] === 0) {
            copy.heart.splice(i, 1);
          }
        }

        console.log(JSON.stringify(copy))
        sock.send(JSON.stringify(copy))

        //Check for empty lists
        for (var attr in copy) {
          if (copy[attr].length < 1) copy[attr] = [0];
        }
      };
      
      $scope.submit = function() {
        //54.88.52.106 note, change this val to ip of server
        sock = new WebSocket("ws://54.88.52.106:8080/team/" + $scope.teamID + "/");
        //console.log ($scope.teamID)
        sock.onopen = function () { }
        sock.onmessage = function (message) {
          var m = JSON.parse(message.data);

          if (m.initial) {
            //Initial message
            m.team.forEach(function(entry) {
                console.log(entry);
              });
            
            $scope.$apply(function() {
                for (var i = 0; i < $scope.image.length; i++) {
                  $scope.image[i] = "http://padherder.com/"+m.team[i].image60_href
                  $scope.stats.hp[i] = m.team[i].stats.hp
                  $scope.stats.atk[i] = m.team[i].stats.atk
                  $scope.stats.rcv[i] = m.team[i].stats.rcv
                  $scope.meta.enhance = m.orb_enhances
                  $scope.meta.rows = m.row_enhances
                }
                if (m.team[0].leader_skill.condition != undefined) {
                  $scope.orbs.leader_skill.condition = m.team[0].leader_skill.condition
                } else{
                  $scope.orbs.leader_skill.condition[0] = "all"
                }
                $scope.orbs.leader_skill.hp = m.team[0].leader_skill.hp
                $scope.orbs.leader_skill.atk = m.team[0].leader_skill.atk
                $scope.orbs.leader_skill.rcv = m.team[0].leader_skill.rcv

                if (m.team[5].leader_skill.condition != null) {
                  $scope.orbs.friend_leader_skill.condition = m.team[5].leader_skill.condition
                } else {
                  $scope.orbs.friend_leader_skill.condition[0] = "all"
                }
                $scope.orbs.friend_leader_skill.hp = m.team[5].leader_skill.hp
                $scope.orbs.friend_leader_skill.atk = m.team[5].leader_skill.atk
                $scope.orbs.friend_leader_skill.rcv = m.team[5].leader_skill.rcv
                // if $scope.orbs.friend_leader_skill.condition[0] === "" {
                // 
                // }
              });
          } else {
            $scope.$apply(function() {
                console.log(JSON.stringify(m))
                $scope.damage = JSON.stringify(m)
              });
          }
        }
      };
    }
    </script>
  </body>
</html>
